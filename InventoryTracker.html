<!DOCTYPE html>
<html>
	<head>

		<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>

		<script> 
			onload = function () {
		       var e = document.getElementById('Strength');
		       e.oninput = calc;

		       e = document.getElementById('copper');
		       e.oninput = total;

		       e = document.getElementById('silver');
		       e.oninput = total;

		       e = document.getElementById('gold');
		       e.oninput = total;

		       e = document.getElementById('platinum');
		       e.oninput = total;
		    };

			var itemsList = new Object();
		    $(function(){
  	      	  $("#Header1").load("Header.html"); 
    		  $("#PH_modules_list").load("Modules.html");

    		  $.get('Items.txt', function(data) {
    		  		var lines = data.split("\n");
    		  		var current = "";
    		  		var depth = 0;
    		  		$(lines).each(function(idx,itm){
    		  			if ($.trim(itm) != "") {
    		  				if (itm.indexOf("/") == 1) {
    		  					depth -= 1;
    		  					if (depth == 0){
    		  						current = "";
    		  					} else {
    		  						itemsList[current].push("");
    		  					}
    		  				} else {
    		  					if (current == "") {
    		  						var item = itm.replace('<', '');
    		  						var item = item.replace('>', '');
    		  						var item = item.trim();

    		  						itemsList[item] = new Array()
    		  						current = item;
    		  						depth += 1;

    		  						var button = "<button type=\"button\" onclick=\"changeList('" + item + "')\">" + item + "</button>";
    		  						$("#itemsDiv").prepend(button)
    		  					} else {
    		  						itemsList[current].push(itm);
    		  						if (itm.indexOf("<") == 0) {
										depth += 1;
    		  						}
								}
		  					}
    		  			}
		  			});
			  }, 'text');
		    });

		    function changeList(name) {
		    	$("#items").empty();
		    	$(itemsList[name]).each(function(idx, itm) {
		    		if (itm.indexOf("<") >= 0) {
		    			itm = itm.replace("<", "-");
		    			itm = itm.replace(">", "-");
		    			var option = '<option value="' + itm + '">' + itm + '</option>';
		    			$("#items").append($(option));
		    		} else {
		    			var info = itm.split("-");
		    			var option = '<option value="'+ info[1] + '">' + info[0] + '</option>';
		    			$("#items").append($(option));
		    		}
		    	});
		    	$("#items").attr("size", itemsList[name].length);
		    }

		   	function add() {
		   		$("#inv tr").last().remove();

		   		var itemName = $("#items option:selected").text();
				var found = false;

		   		if ($.isNumeric($("#items").val())) {
		   			$("#inv tr").each(function(idx,itm){
		   				if ($($(itm).children()[0]).html() == itemName){
		   					var amount = parseInt($($(itm).children().get(1)).html());
		   					amount += 1;
		   					$($(itm).children().get(1)).html(amount);

		   					var weight = parseInt($($(itm).children().get(2)).html());
		   					weight += parseInt($("#items").val());
		   					$($(itm).children().get(2)).html(weight);

		   					found = true;
		   					return false;
		   				}	
		   			});

		   			if (!found) {
			   			var item = ""
			   			item += "<tr><td>";
			   			item += itemName
			   			item += "</td><td>";
			   			item += "1";
			   			item += "</td><td>";
			   			item += $("#items").val();
			   			item += "</td><td>";
			   			item += "<button id=\"remove_but\" type=\"button\" onclick=\"increment(this, 1)\">+1</button>"
			   			item += "<button id=\"remove_but\" type=\"button\" onclick=\"increment(this, -1)\">-1</button>"
			   			item += "<button id=\"remove_but\" type=\"button\" onclick=\"removeItem(this)\">Remove</button>"
			   			item += "</td></tr>";

			   			$("#inv").append(item);
		   			}
		   		}
		   		total();
		   	}

		   	function total() {
		   		if ($($("#inv tr").last().children().get(0)).html() == "<b>Total Weight</b>"){
		   			$("#inv tr").last().remove();
		   		}

		   		var total = 0;
		   		$("#inv tr").each(function(idx, itm){
		   			if ($.isNumeric($($(itm).children()[2]).html())){
		   				total += parseInt($($(itm).children()[2]).html());
		   			}
		   		});

		   		var copperAmount = parseInt($("#copper").val()) || 0;
		   		var silverAmount = parseInt($("#silver").val()) || 0;
		   		var goldAmount = parseInt($("#gold").val()) || 0;
		   		var platinumAmount = parseInt($("#platinum").val()) || 0;

		   		total += Math.floor((copperAmount + silverAmount + goldAmount + platinumAmount) / 50);

		   		$("#weight").html("Total Weight: " + total);

		   		var item;
		   		item += "<tr><td>";
	   			item += "<b>Total Weight</b>";
	   			item += "</td><td>";
	   			item += total;
	   			item += "</td></tr>";
	   			$("#inv").append(item);

	   			calc();
		   	}

		   	function removeItem(sender) {
				$(sender).parent().parent().remove();
				$("#inv tr").last().remove();
				total();
			}

			function calc() {
				if ($.isNumeric($("#Strength").val())) {
					var encumbered = 5 * $("#Strength").val();
					var heavy = 10 * $("#Strength").val();
					var max = 15 * $("#Strength").val();

					var total = parseInt($($("#inv tr").last().children().get(1)).html());

					if (total < encumbered){
						$("#capacity").html("Carrying Cappacity: " + encumbered);
						$("#Free").html("Free Weight: " + (encumbered - total));
						$("#Effects").html("Current Effects: None");
					} else if (total < heavy) {
						$("#capacity").html("Carrying Cappacity: " + heavy);
						$("#Free").html("Free Weight: " + (heavy - total));
						$("#Effects").html("Current Effects: Encumbered");
					} else if (total < max) {
						$("#capacity").html("Carrying Cappacity: " + max);
						$("#Free").html("Free Weight: " + (max - total));
						$("#Effects").html("Current Effects: Heavily Encumbered");
					} else {
						$("#capacity").html("Carrying Cappacity: " + max);
						$("#Free").html("Free Weight: 0");
						$("#Effects").html("Current Effects: Over Weight");
					}
				}
			}

			function save() {
				var saveStr = new Object();

				saveStr["strength"] = $("#Strength").val();

				saveStr["table"] = JSON.stringify($($("#inv").get(0)).html());

				saveStr["copper"] = $("#copper").val();
				saveStr["silver"] = $("#silver").val();
				saveStr["gold"] = $("#gold").val();
				saveStr["platinum"] = $("#platinum").val();

				alert("Copy and store this string:\n" + JSON.stringify(saveStr));
			}

			function load() {
				var loadStr = JSON.parse(window.prompt("Load","Enter saved string"));

				if (loadStr != null) {
					$("#Strength").val(loadStr["strength"]);

					$($("#inv").get(0)).html(JSON.parse(loadStr["table"]));

					$("#copper").val(loadStr["copper"]);
					$("#silver").val(loadStr["silver"]);
					$("#gold").val(loadStr["gold"]);
					$("#platinum").val(loadStr["platinum"]);
				}

				$("#inv tr").last().remove();
				total();
			}

			function increment(sender, inc) {
				var row = $(sender).parent().parent();
				var amount = parseInt($($(row).children().get(1)).html());
				var weight = parseInt($($(row).children().get(2)).html()) / amount;

				amount += inc;

				if (amount == 0) {
					removeItem(sender);
				} else {
					$($(row).children().get(1)).html(amount);
					$($(row).children().get(2)).html(weight * amount);
				}
				$("#inv tr").last().remove();
				total();
			}
		</script> 

		<style>
		    #inventory { 
		        width: 49%;
		        display: inline-block;
		        vertical-align: top;
		    }
		    #itemsDiv { 
		        width: 49%;
		        display: inline-block;
		        vertical-align: top;
		    }
	    </style>

		<title>DND TOOLS</title> 
	</head>
	<link rel="stylesheet" type="text/css" href="DNDStyle.css">
	<body>
		<div Id = "Header1">
			<! import header goes here />
		</div>
		<div Class = "sickdragonimg_ph">
		</div>
		<div class= "body_content">
			<div class= "PH_ads">
				<p>w/e here</p>
			</div>
			<div class= "PH_main_content" id="main">
				<div id="inventory">
					Character Strength: <input type="text" id="Strength" onchange="calc()">
					<br />
					<span id="capacity">Carrying Cappacity: 0</span>
					<br />
					<span id="weight">Total Weight: 0</span>
					<br />
					<span id="Free">Free Weight: 0</span>
					<br />
					<span id="Effects">Current Effects: None</span>
					<br />
					<b>Current Inventory:</b>
					<br />
					<table id="inv" border="1">
					<tr>
						<th>Item Name</th>
						<th>Amount</th>
						<th>Weight</th>
					</tr>
					<tr>
						<td><b>Total Weight</b></td>
						<td>0</td>
					</tr>
				</table>

				<button id="add" type="button" onclick="save()">Save</button>
				<button id="add" type="button" onclick="load()">Load</button>
				<br />
				Copper Coins: <input type="text" id="copper" onchange="total()">
				<br />
				Silver Coins: <input type="text" id="silver" onchange="total()">
				<br />
				Gold Coins: <input type="text" id="gold" onchange="total()">
				<br />
				Platinum Coins: <input type="text" id="platinum" onchange="total()">
				<br />
				</div>
				<div id="itemsDiv">
					<br />
					Items: <br /> <select id="items" size="40" style='height: 100%; max-height: 700px'> </select><br />
					<button id="add" type="button" onclick="add()">Add Item</button>
				</div>
				
			</div>
			<div class= "PH_modules_list" id="PH_modules_list">
			</div>
		</div>
		<div class = "footer">
			<div class ="navbar">
				<p>Navbar</p>
			</div>
		</div>
	</body>
</html>

